import {db_schemaData} from "./db_schema.data.js"
import {writeFileSync} from "node:fs"
import * as process from "node:process"
import {createTableSQLDefinitions} from "./db_schema.utils.js";

if (process.argv.length < 3) {
  console.log("Usage: node db_schema.generate.js [output file name]\n Default output file name is create-tables.sql")
}

const scriptName = process.argv[1].split(/[/\\]/).pop()

const outputFile = "./" + ((process.argv.length > 2) ? process.argv[2] : "create-tables.sql")

const sql_statements = []

sql_statements.push(`/* Generated by ${scriptName} from db_schema.data.js */`)
sql_statements.push("CREATE DATABASE `" + db_schemaData.databaseName + "`")
sql_statements.push("USE `" + db_schemaData.databaseName + "`")
sql_statements.push("DROP TABLE IF EXISTS\n  `" + Object.keys(db_schemaData.tables).join("`,\n  `") + "`")
sql_statements.push(createTableSQLDefinitions(db_schemaData.tables, db_schemaData.types))

const outputContent = sql_statements.join(";\n\n")

try {
  writeFileSync(outputFile, outputContent, {flag: "w+"})
} catch (err) {
  console.error(err)
}
